jobs:
  - job: build_all_linux
    displayName: Build all tasks (Linux)
    timeoutInMinutes: 120
    pool:
      vmImage: ubuntu-latest
    variables:
      - name: workDirectory
        value: $(Build.SourcesDirectory)
    steps:
      - script: |
          echo $(Build.SourcesDirectory)
      - task: DockerCompose@0
        inputs:
          containerregistrytype: 'Azure Container Registry'
          dockerComposeFile: 'workflow/docker-compose.yml'
          dockerComposeFileArgs:
            - "workDirectory=$(Build.SourcesDirectory)"
          action: 'Run a Docker Compose command'
      - task: UseDotNet@2
        displayName: "Install .NET Core SDK"
        inputs:
          version: 5.0.100
      - task: UseDotNet@2
        displayName: "Install .NET Core SDK"
        inputs:
          version: 3.1.403
      - script: bash scripts/build.sh
        displayName: "Build"
      - script: bash scripts/test.sh
        displayName: "Run unit test"
      - task: Palmmedia.reportgenerator.reportgenerator-build-release-task.reportgenerator@4
        displayName: ReportGenerator
        inputs:
          reports: "$(Build.SourcesDirectory)/test/Unit/*/TestResults/*/coverage.cobertura.xml"
          targetdir: "$(Build.SourcesDirectory)/CodeCoverage"
          reporttypes: "Cobertura"
          assemblyfilters: "-xunit*"
      - script: bash <(curl -s https://codecov.io/bash)
        displayName: "Upload to codecov.io"
